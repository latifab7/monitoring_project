---

- name: configure our test instance
  hosts: test_instance
  remote_user: admin
  become: true
  vars:   
    domain_name : "test.istla.online" #"{{ lookup('env', 'DOMAIN_NAME_FRONT') }}" 

  tasks:

# STEP 1 : UPDATE SYSTEM

  - name: update system 
    ansible.builtin.apt:
      update_cache : yes

# STEP 2 : INSTALL NGinx
  - name: Copy nginx script to target
    copy:
      src: ../scripts/setup_nginx.sh
      dest: /opt/setup_nginx.sh
      mode: '0755'

  - name: Execute nginx installation 
    command: /opt/setup_nginx.sh 

# step 3 : REPLACE NGINX DEFAULT HTML BY OUR CUSTOM HTML

  - name: Copy custom HTML to replace default Nginx page
    copy:
      src: ../files/index.html
      dest: /usr/share/nginx/html/index.html
      owner: www-data
      group: www-data
      mode: '0644'

  - name: restart nginx 
    systemd:
      name: nginx
      state: reloaded


# STEP 4 :  SSL CERTIFICATE 

  - name: Install ssl
    apt:
      name: 
        - certbot
        - python3-certbot-nginx
      state: present

  - name: configure nginx default file with domain name 
    copy: 
      dest: /etc/nginx/conf.d/static_site.conf
      content: |
        server {
          listen 80;
          server_name {{ domain_name }};

          root /usr/share/nginx/html;
          index index.html

          location / {
            try_files $uri $uri/ = 404   
          }
        }

  - name: obtain ssl certificate fot https 
    command: certbot --nginx -d {{ domain_name }} --non-interactive --agree-tos -m latifaboulil@hotmail.fr

  - name: restart nginx 
    systemd:
      name: nginx
      state: reloaded


